<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Disable Yandex Turbo (RSS Generator)</title>
        <style>
.slider,button{cursor:pointer}body{background:#fff;color:#333;font:16px/1 Arial,sans-serif;margin:3%;width:500px;text-align:left}button,form,label{margin-bottom:5px}label{display:block}textarea{box-sizing:border-box;width:100%}button{background:#008cba;border:none;border-radius:3px;color:#fff;font-size:16px;padding:10px 20px;transition:background-color .2s}button:disabled{background:gray;color:#ccc;border:1px solid #ccc;cursor:not-allowed}#output{margin-top:5px;height:150px;background:#ccc}#copy-message{position:absolute;top:10px;right:10px;padding:10px;background:#007bff;color:#fff;display:none}#error-message{color:red}#error-message:empty+#generate-button{background:gray;color:#fff;cursor:not-allowed}#error-message:empty+#generate-button:hover{background:#a9a9a9}.clear-error-button{background:#fff;color:red;border:1px solid red;font-size:16px;margin-bottom:5px;padding:3px 10px}.slider,.switch .slider:before,.switch input:checked+.slider{background:#ccc}.slider.round:before,.slider:before{border-radius:50%}.switch{position:relative;display:inline-block;width:20px;height:20px}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;top:0;left:0;right:0;bottom:0;opacity:1;transition:.1s;border-radius:20px}.slider:before{position:absolute;content:"";height:15px;width:15px;left:4px;bottom:4px;background:#fff;opacity:0;transition:.4s}input:checked+.slider{background:#2196f3}input:focus+.slider{box-shadow:0 0 1px #2196f3}input:checked+.slider:before{transform:translateX(2px)}.slider.round{border-radius:10px}body.dark-theme{background:#111;color:#fff}.switch .slider,.switch input:checked+.slider:before{background:#222}
        </style>
    </head>
    <body>
        <h2>Disable Yandex Turbo (RSS Generator) </h1>
            <label class="switch">
                <input type="checkbox">
                <span class="slider round"></span>
            </label>
            <form>
                <div style="position: relative">
                    <label for="input">Input URLs (one per line):</label>
					<br>
					<div id="count-message"></div>

                    <br>
                    <textarea id="input" name="input" rows="4" cols="50" oninput="validateInput()"></textarea>
                    <div id="line-numbers"></div>
                </div>
                <button type="button" onclick="importCSV()">Import CSV</button>
                <button id="clear-button" disabled>Clear Input</button>
                <button type="button" onclick="generateXML()" disabled>Generate RSS</button>
                <div id="error-message" style="color: red"></div>
            </form>
            <br>
            <label for="output">Output:</label>
            <br>
            <textarea id="output" name="output" rows="10" cols="80" onclick="copyOutput()" readonly></textarea>
            <script>
const switchBtn = document.querySelector('.switch input[type="checkbox"]');
const body = document.querySelector('body');

// Получаем значение из localStorage и устанавливаем состояние темы
const isDarkTheme = localStorage.getItem('isDarkTheme') === 'true';
body.classList.toggle('dark-theme', isDarkTheme);
switchBtn.checked = isDarkTheme;

// Сохраняем состояние темы в localStorage при изменении состояния переключателя
switchBtn.addEventListener('change', function() {
  const isDarkTheme = switchBtn.checked;
  localStorage.setItem('isDarkTheme', isDarkTheme);
  body.classList.toggle('dark-theme', isDarkTheme);
});


		
function importCSV() {
  // создаем input элемент для выбора файла
  var input = document.createElement('input');
  input.type = 'file';
  
  // при выборе файла, обрабатываем его содержимое
  input.onchange = function() {
    var file = input.files[0];
    var reader = new FileReader();
    var button = document.querySelector('button[type="button"]');
    button.disabled = true;
    button.textContent = 'Подождите...';
    clearButton.disabled = true;
    
    reader.onload = function(event) {
      // парсим содержимое файла
      var lines = event.target.result.split('\n');
      var urls = [];
      for (var i = 1; i < lines.length; i++) {
        var columns = lines[i].split(',');
        if (columns.length >= 5 && columns[4] !== '') {
          urls.push(columns[4].replace(/"/g, ''));
        }
      }
      
      // вставляем URL-ы в textarea
      var input = document.getElementById('input');
      input.value = urls.join('\n');
	  
	  // получаем элементы
      const tooltipinput = document.querySelector("#input");

      // сбрасываем состояние кнопки
      var button = document.querySelector('button[type="button"]');
      button.disabled = false;
      button.textContent = 'Import CSV';
      clearButton.disabled = false;

      // выводим подсказку
      const tooltipInput = document.createElement("div");
      tooltipInput.innerHTML = "CSV-файл загружен";
      tooltipInput.style.position = "absolute";
      tooltipInput.style.bottom = "10%";
      tooltipInput.style.left = "50%";
      tooltipInput.style.transform = "translateX(-50%)";
      tooltipInput.style.padding = "10px 10px";
      tooltipInput.style.background = "#333";
      tooltipInput.style.color = "#fff";
      tooltipInput.style.opacity = "80%";
      tooltipInput.style.borderRadius = "5px";
      tooltipInput.style.zIndex = "999";
      input.parentNode.style.position = "relative";
      input.parentNode.insertBefore(tooltipInput, input);

      // скрываем подсказку через 2 секунды
      setTimeout(() => {
        tooltipInput.remove();
      }, 2000);
      
      // запуск валидации после импорта данных
      validateInput();	  
    };
    
    reader.readAsText(file);
  };

  // открываем окно выбора файла
  input.click();
}




function validateInput() {
  var input = document.getElementById('input');
  var errorMessage = document.getElementById('error-message');
  var countMessage = document.getElementById('count-message');
  var value = input.value.trim();

  // Check if the input is empty or contains only spaces
  if (value.length === 0) {
    errorMessage.textContent = 'Введите URL';
    const generateButton = document.querySelector('button[onclick="generateXML()"]');
    generateButton.disabled = true;
    return;
  }
  // Check if any URLs are invalid
  var lines = value.split('\n');
  var invalidLines = lines.filter(line => !/^https?:\/\/[\w\-]+(\.[\w\-]+)+[/#?]?.*$/.test(line));
  if (invalidLines.length > 0) {
    // Clear the error message
    errorMessage.textContent = '';

    // Add the "Clear Errors" button
    const clearErrorsButton = document.createElement('button');
    clearErrorsButton.textContent = 'Очистить ошибки';
    clearErrorsButton.classList.add('clear-error-button');
    clearErrorsButton.addEventListener('click', function() {
      // Remove the invalid lines from the input
      input.value = lines.filter(line => /^https?:\/\/[\w\-]+(\.[\w\-]+)+[/#?]?.*$/.test(line)).join('\n');
      errorMessage.textContent = '';
      clearErrorsButton.style.display = 'none';
      const generateButton = document.querySelector('button[onclick="generateXML()"]');
      generateButton.disabled = false;
    });
    errorMessage.appendChild(clearErrorsButton);

    // Show the error message
    errorMessage.appendChild(document.createElement('br'));
    errorMessage.appendChild(document.createTextNode(`Invalid URLs: ${invalidLines.join(', ')}`));
    const generateButton = document.querySelector('button[onclick="generateXML()"]');
    generateButton.disabled = true;
  } else {
    errorMessage.textContent = '';
    const generateButton = document.querySelector('button[onclick="generateXML()"]');
    generateButton.disabled = false;
  }

  // Update the count message
  countMessage.textContent = `Количество URL: ${lines.length}`;
}



var input = document.getElementById('input');
  var clearButton = document.getElementById('clear-button');

  input.addEventListener('input', function() {
    clearButton.disabled = !input.value;
  });

  clearButton.addEventListener('click', function() {
    input.value = '';
    clearButton.disabled = true;
	validateInput();	 
  });



function generateXML() {
  const errorMessage = document.getElementById('error-message').textContent;
  const generateButton = document.querySelector('button[onclick="generateXML()"]');

  if (errorMessage) {
    generateButton.disabled = true;
    return;
  }

  generateButton.disabled = false;

  const inputStrings = document.getElementById('input').value.trim();

  if (!inputStrings) {
    return;
  }

  const xmlDoc = new DOMParser().parseFromString('<rss version="2.0" xmlns:yandex="http://news.yandex.ru" xmlns:media="http://search.yahoo.com/mrss/" xmlns:turbo="http://turbo.yandex.ru"></rss>', 'text/xml');
  const channelElement = xmlDoc.createElement('channel');
  xmlDoc.documentElement.appendChild(channelElement);

  for (const inputString of inputStrings.split('\n')) {
    const itemElement = xmlDoc.createElement('item');
    itemElement.setAttribute('turbo', 'false');
    const linkElement = xmlDoc.createElement('link');
    linkElement.textContent = inputString;
    itemElement.appendChild(linkElement);
    channelElement.appendChild(itemElement);
  }

  const formattedXmlString = formatXml(new XMLSerializer().serializeToString(xmlDoc));
  const blob = new Blob([formattedXmlString], { type: 'application/xml' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  const domainName = inputStrings.split('\n')[0].split('/')[2].replace(/[^a-zA-Z0-9]/g, '_');
  link.href = url;
  link.download = `${domainName}_turbo_off.xml`;

  if (document.getElementById('download-button')) {
    document.getElementById('download-button').remove();
  }

  const newButton = document.createElement('button');
  newButton.id = 'download-button';
  newButton.textContent = 'Download';
  newButton.addEventListener('click', () => {
    document.body.appendChild(link);
    link.click();
  });

  document.body.appendChild(newButton);
  document.getElementById('output').value = formattedXmlString;
}




const textarea = document.getElementById("output");

textarea.addEventListener("click", function() {
  copyText();
});


      function formatXml(xml) {
        var formatted = '';
        var reg = /(>)(<)(\/*)/g;
        xml = xml.replace(reg, '$1\r\n$2$3');
        var pad = 0;
        xml.split('\r\n').forEach(function (node, index) {
          var indent = 0;
          if (node.match(/.+<\/\w[^>]*>$/)) {
            indent = 0;
          } else if (node.match(/^<\/\w/)) {
            if (pad != 0) {
              pad -= 1;
            }
          } else if (node.match(/^<\w([^>]*[^\/])?>.*$/)) {
            indent = 1;
          } else {
            indent = 0;
          }

          var padding = '';
          for (var i = 0; i < pad; i++) {
            padding += '  ';
          }

          formatted += padding + node + '\r\n';
          pad += indent;
        });

        return formatted;
      }
	  
	  
	  function copyOutput() {
  var output = document.getElementById('output');
  output.select();
  document.execCommand('copy');
}
	  
	  function copyText() {
  // получаем textarea и его содержимое
  const textarea = document.getElementById("output");
  const text = textarea.value;

  // копируем текст в буфер обмена
  navigator.clipboard.writeText(text);

// получаем элементы
const output = document.querySelector("#output");

// выводим подсказку
const tooltipOutput = document.createElement("div");
tooltipOutput.innerHTML = "Текст скопирован";
tooltipOutput.style.position = "absolute";
tooltipOutput.style.bottom = "10%";
tooltipOutput.style.left = "50%";
tooltipOutput.style.transform = "translateX(-50%)";
tooltipOutput.style.padding = "10px 10px";
tooltipOutput.style.background = "#333";
tooltipOutput.style.color = "#fff";
tooltipOutput.style.opacity = "80%";
tooltipOutput.style.borderRadius = "5px";
tooltipOutput.style.zIndex = "999";
output.parentNode.style.position = "relative";
output.parentNode.insertBefore(tooltipOutput, output);

// скрываем подсказку через 2 секунды
setTimeout(() => {
  tooltipOutput.remove();
}, 2000);

}

            </script>
    </body>
</html>